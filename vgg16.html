<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>VGG16</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0"></script>
</head>

<body>
<h2>VGG16 ImageNet Prediction</h2>

<input type="file" id="upload"><br><br>

Image URL:
<input type="text" id="url" size="50">
<button onclick="loadFromURL()">Load URL</button>

<br><br>
<img id="image" width="224" crossorigin="anonymous">
<br><br>

<button onclick="predict()">Predict</button>

<h3>Result</h3>
<ul id="result"></ul>

<script>
let model;
let classIndex;

// Load ImageNet labels
fetch("https://storage.googleapis.com/download.tensorflow.org/data/imagenet_class_index.json")
  .then(r => r.json())
  .then(data => classIndex = data);

// Load VGG16 model
async function loadModel() {
  document.getElementById("result").innerHTML =
    "<li>Loading VGG16 model… (be patient)</li>";

  model = await tf.loadGraphModel(
    "https://storage.googleapis.com/tfjs-models/tfjs/vgg16/model.json"
  );

  document.getElementById("result").innerHTML =
    "<li>Model loaded</li>";
}
loadModel();

// Upload image
document.getElementById("upload").addEventListener("change", e => {
  document.getElementById("image").src =
    URL.createObjectURL(e.target.files[0]);
});

// Load from URL
function loadFromURL() {
  document.getElementById("image").src =
    document.getElementById("url").value;
}

// Predict
async function predict() {
  const img = document.getElementById("image");

  let tensor = tf.browser.fromPixels(img)
    .resizeNearestNeighbor([224, 224])
    .toFloat()
    .expandDims(0);

  // VGG16 preprocessing (BGR + mean subtraction)
  const mean = tf.tensor1d([123.68, 116.779, 103.939]);
  tensor = tensor.sub(mean);

  const logits = model.predict(tensor);
  const probs = logits.softmax().dataSync();

  const top5 = [...probs]
    .map((p, i) => ({ p, i }))
    .sort((a, b) => b.p - a.p)
    .slice(0, 5);

  const ul = document.getElementById("result");
  ul.innerHTML = "";

  top5.forEach(t => {
    const label = classIndex[t.i][1];
    const li = document.createElement("li");
    li.innerText = `${label} — ${(t.p * 100).toFixed(2)}%`;
    ul.appendChild(li);
  });
}
</script>

</body>
</html>
